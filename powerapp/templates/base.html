<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Smart Power Saver{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%' stop-color='%23ef4444'/%3E%3Cstop offset='100%' stop-color='%23b91c1c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='14' fill='%23121111'/%3E%3Cpath d='M36 6 14 36h12l-2 22 24-34H36z' fill='url(%23g)'/%3E%3C/svg%3E">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
</head>
<body data-theme="light">
    <nav class="navbar">
        <div class="nav-container">
            <div id="ist-clock" class="ist-clock"></div>
            <div class="nav-logo">
                <i class="fas fa-bolt"></i>
                <span class="brand-gradient">Smart Power Saver</span>
            </div>
            <div class="nav-menu">
                <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
                <a href="{% url 'control' %}" class="nav-link {% if request.resolver_match.url_name == 'control' %}active{% endif %}">
                    <i class="fas fa-sliders-h"></i>
                    Control
                </a>
                <a href="{% url 'analytics' %}" class="nav-link {% if request.resolver_match.url_name == 'analytics' %}active{% endif %}">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </a>
                <a href="{% url 'compare' %}" class="nav-link {% if request.resolver_match.url_name == 'compare' %}active{% endif %}">
                    <i class="fas fa-columns"></i>
                    Compare
                </a>
                <a href="{% url 'rules' %}" class="nav-link {% if request.resolver_match.url_name == 'rules' %}active{% endif %}">
                    <i class="fas fa-robot"></i>
                    Rules
                </a>
                <a href="{% url 'notifications_page' %}" class="nav-link {% if request.resolver_match.url_name == 'notifications_page' %}active{% endif %}">
                    <i class="fas fa-bell"></i>
                    Alerts
                </a>
                <a href="{% url 'history' %}" class="nav-link {% if request.resolver_match.url_name == 'history' %}active{% endif %}">
                    <i class="fas fa-clock"></i>
                    History
                </a>
                <a href="{% url 'suggestions' %}" class="nav-link {% if request.resolver_match.url_name == 'suggestions' %}active{% endif %}">
                    <i class="fas fa-lightbulb"></i>
                    Suggestions
                </a>
                <a href="{% url 'management' %}" class="nav-link {% if request.resolver_match.url_name == 'management' %}active{% endif %}">
                    <i class="fas fa-users-cog"></i>
                    Manage
                </a>
                <a href="{% url 'settings' %}" class="nav-link {% if request.resolver_match.url_name == 'settings' %}active{% endif %}">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
                {% if request.user.is_authenticated %}
                <a href="{% url 'logout' %}" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
                {% else %}
                <a href="{% url 'login' %}" class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}"><i class="fas fa-sign-in-alt"></i> Login</a>
                <a href="{% url 'signup' %}" class="nav-link {% if request.resolver_match.url_name == 'signup' %}active{% endif %}"><i class="fas fa-user-plus"></i> Sign Up</a>
                {% endif %}
                <button id="theme-toggle" class="btn btn-secondary theme-toggle" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Fullscreen background GIF (place file at powerapp/static/background.gif) -->
    <div class="bg-gif" style="background-image:url('{% static 'background.gif' %}')"></div>

    <main class="main-content">
        {% block content %}{% endblock %}
        <div id="welcome-overlay" class="welcome-overlay">
            <div class="welcome-card">
                <img id="welcome-gif" class="welcome-gif" src="{% static 'welcome.gif' %}" alt="Welcome" onerror="this.style.display='none'" />
                <div id="welcome-anim" class="welcome-anim"></div>
                <div class="welcome-title">Welcome, {{ request.user.username|default:'Guest' }}!</div>
                <div class="welcome-sub">Great to see you back. Optimizing your energy now...</div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Smart Power Saver. All rights reserved.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Support</a>
            </div>
        </div>
    </footer>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        // Persisted theme
        (function initTheme() {
            try {
                const stored = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = stored || (prefersDark ? 'dark' : 'light');
                document.body.setAttribute('data-theme', theme);
                const btn = document.getElementById('theme-toggle');
                if (btn) btn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            } catch (e) {}
        })();

        // Theme toggle handler
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('theme-toggle');
            if (!toggle) return;
            toggle.addEventListener('click', function() {
                const current = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
                const next = current === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', next);
                try { localStorage.setItem('theme', next); } catch (e) {}
                toggle.innerHTML = next === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            });
        });
        // Show welcome overlay after login (once per session) or immediately if coming from login/referrer
        document.addEventListener('DOMContentLoaded', function(){
            try {
                const overlay = document.getElementById('welcome-overlay');
                const isAuth = {{ request.user.is_authenticated|yesno:'true,false' }};
                const params = new URLSearchParams(window.location.search);
                const fromLogin = (document.referrer || '').includes('/login');
                const force = params.has('welcome') || fromLogin;
                const wasShown = sessionStorage.getItem('welcome_shown');
                if (overlay && isAuth && (force || !wasShown)) {
                    overlay.style.display = 'flex';
                    // Initialize animated image via Lottie if available
                    try {
                        if (window.lottie && document.getElementById('welcome-anim')) {
                            window.lottie.loadAnimation({
                                container: document.getElementById('welcome-anim'),
                                renderer: 'svg',
                                loop: true,
                                autoplay: true,
                                // Energy themed animation
                                path: 'https://assets10.lottiefiles.com/packages/lf20_s5zxtnbh.json'
                            });
                        }
                    } catch (e) {}
                    setTimeout(()=>{
                        overlay.classList.add('welcome-hide');
                        sessionStorage.setItem('welcome_shown','1');
                        if (params.has('welcome')) {
                            params.delete('welcome');
                            const url = window.location.pathname + (params.toString()?('?'+params.toString()):'');
                            window.history.replaceState({}, '', url);
                        }
                    }, 2200);
                }
            } catch (e) {}
        });
        // AI chat widget (ensure DOM is ready before querying elements)
        document.addEventListener('DOMContentLoaded', function(){
            const toggle = document.getElementById('ai-toggle');
            const panel = document.getElementById('ai-chat-panel');
            const closeBtn = document.getElementById('ai-close');
            const input = document.getElementById('ai-input');
            const send = document.getElementById('ai-send');
            const log = document.getElementById('ai-messages');
            const indicator = document.getElementById('ai-indicator');
            function add(role, text){
                const wrap = document.createElement('div');
                wrap.style.margin = '6px 0';
                wrap.className = 'ai-msg ' + (role==='user'?'ai-user':'ai-bot');
                wrap.textContent = text;
                log && log.appendChild(wrap); if(log) log.scrollTop = log.scrollHeight;
            }
            function addTyping(){
                const wrap = document.createElement('div'); wrap.style.margin='6px 0'; wrap.className='ai-msg ai-bot';
                wrap.innerHTML = '<span class="ai-typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
                log && log.appendChild(wrap); if(log) log.scrollTop = log.scrollHeight;
                return wrap;
            }
            function sendMsg(){
                const msg = (input && input.value||'').trim(); if(!msg) return; add('user', msg); if(input) input.value='';
                const typing = addTyping(); indicator && (indicator.style.display='inline');
                fetch('{% url 'api_chat' %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: JSON.stringify({message: msg})})
                    .then(r=>r.json()).then(j=>{ typing.remove(); add('assistant', j.reply||''); })
                    .catch(()=> { typing.remove(); add('assistant','Sorry, something went wrong.'); })
                    .finally(()=> { indicator && (indicator.style.display='none'); });
            }
            if(toggle){ toggle.addEventListener('click', ()=>{ if(!panel) return; panel.style.display = (panel.style.display && panel.style.display!=='none') ? 'none' : 'block'; }); }
            if(closeBtn){ closeBtn.addEventListener('click', ()=> { if(panel) panel.style.display='none'; }); }
            if(send){ send.addEventListener('click', sendMsg); }
            if(input){ input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendMsg(); }}); }
            document.querySelectorAll('.ai-act').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const act = btn.getAttribute('data-act');
                    if(act==='toggle_lights'){ add('user','Turn off lights'); fetch('{% url 'api_chat' %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: JSON.stringify({message: 'Turn off lights'})}).then(r=>r.json()).then(j=> add('assistant', j.reply||'')); }
                    if(act==='check_usage'){ add('user','Check energy usage'); fetch('{% url 'api_chat' %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: JSON.stringify({message: 'Check energy usage'})}).then(r=>r.json()).then(j=> add('assistant', j.reply||'')); }
                    if(act==='set_schedule'){ add('user','Set schedule'); fetch('{% url 'api_chat' %}', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken}, body: JSON.stringify({message: 'Set schedule'})}).then(r=>r.json()).then(j=> add('assistant', j.reply||'')); }
                });
            });
        });
        // IST clock (UTC+5:30) at top-left
        document.addEventListener('DOMContentLoaded', function(){
            const el = document.getElementById('ist-clock');
            if(!el) return;
            function pad(n){ return n<10?('0'+n):n; }
            function tick(){
                const now = new Date();
                // compute IST by adding 5h30m offset from UTC
                const ist = new Date(now.getTime() + (now.getTimezoneOffset() * -60000) + (5.5 * 3600000));
                const d = ist.getDate();
                const m = ist.toLocaleString('en-GB', { month: 'short' });
                const y = ist.getFullYear();
                const h = pad(ist.getHours());
                const mi = pad(ist.getMinutes());
                const s = pad(ist.getSeconds());
                el.textContent = `${d} ${m} ${y} • ${h}:${mi}:${s} IST`;
            }
            tick();
            setInterval(tick, 1000);
        });
    </script>
    <!-- Floating AI Chat Widget -->
    <div id="ai-chat" style="position:fixed; right:20px; bottom:20px; z-index:3000;">
        <div id="ai-chat-panel" class="glass-surface" style="display:none; width:340px; border-radius:16px; box-shadow: 0 8px 24px rgba(236,72,153,.25); overflow:hidden;">
            <div style="padding:12px 14px; background: linear-gradient(135deg, #3b82f6, #ff4da6); color:#fff; display:flex; justify-content:space-between; align-items:center;">
                <strong><i class="fas fa-robot"></i> SmartSaver AI</strong>
                <div>
                    <span id="ai-indicator" style="display:none;margin-right:8px;animation:pulse 1.2s infinite;">●</span>
                    <button id="ai-close" class="btn btn-sm" style="background:transparent;color:#fff"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="ai-messages" style="height:300px; padding:12px; overflow:auto; background:var(--card-bg);">
                <div class="ai-msg ai-bot">Hi! I’m your energy assistant. Try quick actions below.</div>
                <div class="ai-quick">
                    <button class="btn btn-primary btn-sm glow-hover ai-act" data-act="toggle_lights"><i class="fas fa-lightbulb"></i> Turn off lights</button>
                    <button class="btn btn-primary btn-sm glow-hover ai-act" data-act="check_usage"><i class="fas fa-chart-line"></i> Check energy usage</button>
                    <button class="btn btn-primary btn-sm glow-hover ai-act" data-act="set_schedule"><i class="fas fa-clock"></i> Set schedule</button>
                </div>
            </div>
            <div style="display:flex; gap:8px; padding:10px; background:var(--card-bg); border-top:1px solid var(--border-color);">
                <input id="ai-input" class="form-input" placeholder="Ask about energy savings..." />
                <button id="ai-send" class="btn btn-primary glow-hover"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <button id="ai-toggle" class="btn btn-primary glow-hover" title="Ask SmartSaver AI" style="border-radius:999px; width:56px; height:56px; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-robot"></i>
        </button>
    </div>
    <script src="{% static 'app.js' %}"></script>
    <!-- Floating quick action button stack -->
    <div style="position:fixed; right:20px; bottom:90px; display:flex; flex-direction:column; gap:10px; z-index:2800;">
        <a href="{% url 'control' %}" class="btn btn-primary glow-hover" style="border-radius:999px; padding:12px 14px;"><i class="fas fa-sliders-h"></i></a>
        <a href="{% url 'analytics' %}" class="btn btn-primary glow-hover" style="border-radius:999px; padding:12px 14px;"><i class="fas fa-chart-line"></i></a>
        <a href="{% url 'rules' %}" class="btn btn-primary glow-hover" style="border-radius:999px; padding:12px 14px;"><i class="fas fa-clock"></i></a>
    </div>
</body>
</html>
