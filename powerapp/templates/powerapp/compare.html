{% extends 'base.html' %}
{% block title %}Compare - Smart Power Saver{% endblock %}

{% block content %}
<div class="compare-page">
    <div class="compare-header">
        <h1><i class="fas fa-columns"></i> Compare Consumption</h1>
        <div class="compare-controls">
            <select id="compare-range" class="form-select">
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="180">Last 6 Months</option>
                <option value="365">Last 12 Months</option>
            </select>
            <select id="compare-room" class="form-select">
                <option value="">All Rooms</option>
                <option>Living Room</option>
                <option>Kitchen</option>
                <option>Bedroom</option>
                <option>Office</option>
                <option>Laundry</option>
            </select>
            <input id="compare-devices" class="form-input" placeholder="Device IDs e.g. 1,2,3" />
            <button class="btn btn-primary" id="compare-apply"><i class="fas fa-play"></i> Apply</button>
        </div>
    </div>

    <div class="compare-grid">
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-bar"></i> By Device (Average W)</h2>
            </div>
            <div class="panel-content" style="height:320px;background:#0b1220;border-radius:12px;">
                <canvas id="bar-by-device"></canvas>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-pie"></i> By Room (Average W)</h2>
            </div>
            <div class="panel-content" style="height:320px;background:#0b1220;border-radius:12px;">
                <canvas id="pie-by-room"></canvas>
            </div>
        </div>
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-ranking-star"></i> Device Ranking</h2>
            </div>
            <div class="panel-content">
                <div class="table-responsive">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Device</th>
                                <th>Room</th>
                                <th>Avg Power (W)</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const barCtx = document.getElementById('bar-by-device');
    const pieCtx = document.getElementById('pie-by-room');
    let barChart, pieChart;

    function brightPalette(n) {
        const colors = [];
        for (let i=0;i<n;i++) {
            const hue = (i*137.5)%360;
            colors.push(`hsl(${hue}, 100%, 55%)`);
        }
        return colors;
    }

    function hoverShadow(pluginOpts=true){
        return {
            id: 'hover-shadow',
            afterDatasetsDraw(chart, args, pluginOptions) {
                const {ctx, tooltip} = chart;
                if (!tooltip || !tooltip.getActiveElements().length) return;
                const active = tooltip.getActiveElements()[0];
                const dataset = chart.getDatasetMeta(active.datasetIndex);
                const element = dataset.data[active.index];
                ctx.save();
                ctx.shadowColor = 'rgba(0,0,0,0.6)';
                ctx.shadowBlur = 12;
                ctx.shadowOffsetY = 6;
                ctx.fillStyle = element.options.backgroundColor;
                if (element.draw) element.draw(ctx);
                ctx.restore();
            }
        }
    }

    function render(summary) {
        const deviceLabels = summary.by_device.map(x=>x.name);
        const deviceData = summary.by_device.map(x=>x.avg_power);
        const deviceColors = brightPalette(deviceLabels.length);

        const roomLabels = summary.by_room.map(x=>x.room);
        const roomData = summary.by_room.map(x=>x.avg_power);
        const roomColors = brightPalette(roomLabels.length);

        barChart && barChart.destroy();
        pieChart && pieChart.destroy();

        barChart = new Chart(barCtx, {
            type: 'bar',
            data: { labels: deviceLabels, datasets: [{ data: deviceData, backgroundColor: deviceColors }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display:false }, tooltip: { enabled:true } },
                scales: { x: { ticks: { color:'#e5e7eb' } }, y: { ticks: { color:'#e5e7eb' }, beginAtZero:true } }
            },
            plugins: [hoverShadow()]
        });

        pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: { labels: roomLabels, datasets: [{ data: roomData, backgroundColor: roomColors }] },
            options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'bottom', labels:{ color:'#e5e7eb' } } } },
            plugins: [hoverShadow()]
        });

        const tbody = document.getElementById('ranking-body');
        tbody.innerHTML = '';
        summary.ranking.forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${r.name}</td><td>${r.room || ''}</td><td>${r.avg_power}</td>`;
            tbody.appendChild(tr);
        });
    }

    function fetchSummary() {
        const range = parseInt(document.getElementById('compare-range').value || '30');
        const now = new Date();
        const start = new Date(now.getTime() - range*24*3600*1000);
        const params = new URLSearchParams();
        params.set('start', start.toISOString());
        params.set('end', now.toISOString());
        const room = document.getElementById('compare-room').value;
        if (room) params.set('room', room);
        const devices = document.getElementById('compare-devices').value;
        if (devices) devices.split(',').map(x=>x.trim()).filter(Boolean).forEach(d=>params.append('device', d));
        fetch(`/api/compare/summary/?${params.toString()}`)
            .then(r=>r.json())
            .then(render)
            .catch(err=>console.error('compare summary failed', err));
    }

    document.getElementById('compare-apply').addEventListener('click', fetchSummary);
    fetchSummary();
});
</script>
{% endblock %}

